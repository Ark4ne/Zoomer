/*
 * Zoomer [Formstone Library]
 * Includes Request Animation Frame Polyfill 
 * @author Ben Plum
 * @version 0.2.0
 *
 * Copyright Â© 2013 Ben Plum <mr@benplum.com>
 * Released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 */
 
if(jQuery)(function(d){function f(a){a=d.extend({},g,x,a);for(var c=d(this),b=0,l=c.length;b<l;b++)e.apply(c.eq(b),[d.extend({},a)]);m=d(".zoomer-element");n||(n=!0,s());return c}function e(a){a.$target=d(this);a.marginReal=2*a.margin;a.index=0;a.images=[];a.$target.find("img").each(function(){a.images.push(d(this).attr("src"))});var c='<div class="zoomer '+a.customClass;1<a.images.length&&(c+=" zoomer-gallery");c+='"><div class="zoomer-positioner">';c+='<div class="zoomer-holder">';c+="</div>";c+="</div>"; c+="</div>";a.$zoomer=d(c);a.$target.addClass("zoomer-element").html(a.$zoomer);a.controls.zoomIn||a.controls.zoomOut||a.controls.next||a.controls.previous?(a.controls.$zoomIn=d(a.controls.zoomIn),a.controls.$zoomOut=d(a.controls.zoomOut),a.controls.$next=d(a.controls.next),a.controls.$previous=d(a.controls.previous)):(c='<div class="zoomer-controls zoomer-controls-'+a.controls.position+'">',1<a.images.length&&(c+='<span class="zoomer-previous">&lsaquo;</span>'),c+='<span class="zoomer-zoom-out">-</span>', c+='<span class="zoomer-zoom-in">+</span>',1<a.images.length&&(c+='<span class="zoomer-next">&rsaquo;</span>'),c+="</div>",a.$zoomer.append(c),a.controls.$default=a.$zoomer.find(".zoomer-controls"),a.controls.$zoomIn=a.$zoomer.find(".zoomer-zoom-in"),a.controls.$zoomOut=a.$zoomer.find(".zoomer-zoom-out"),a.controls.$next=a.$zoomer.find(".zoomer-next"),a.controls.$previous=a.$zoomer.find(".zoomer-previous"));a.$positioner=a.$zoomer.find(".zoomer-positioner");a.$holder=a.$zoomer.find(".zoomer-holder"); a.controls.$zoomIn.on("mousedown.zoomer",a,y).on("mouseup.zoomer",a,t);a.controls.$zoomOut.on("mousedown.zoomer",a,z).on("mouseup.zoomer",a,t);a.controls.$next.on("click",a,A);a.controls.$previous.on("click",a,B);a.$zoomer.on("touchstart.zoomer MSPointerDown.zoomer",":not(.zoomer-controls)",a,q);a.$target.data("zoomer",a);p.resize.apply(a.$target);0<a.images.length&&h.apply(a.$target,[a,a.images[0]])}function A(a){a=a.data;!a.loading&&a.index+1<a.images.length&&(a.index++,k.apply(a.$target,[a]))} function B(a){a=a.data;!a.loading&&0<=a.index-1&&(a.index--,k.apply(a.$target,[a]))}function k(a){"undefined"!=typeof a.$image?a.$image.animate({opacity:0},300,function(){p.unload.apply(a.$target);h.apply(a.$target,[a,a.images[a.index]])}):h.apply(a.$target,[a,a.images[a.index]])}function h(a,c){a.loading=!1;a.$image=d('<img style="opacity: 0;" />');a.$image.one("load.zoomer",a,r).attr("src",c).addClass("zoomer-image");a.$image[0].complete&&a.$image.trigger("load")}function r(a){a=a.data;a.originalHeight= a.$image[0].naturalHeight;a.originalWidth=a.$image[0].naturalWidth;a.retina&&(a.originalHeight/=2,a.originalWidth/=2);a.targetImageHeight=a.originalHeight;a.targetImageWidth=a.originalWidth;a.maxHeight=a.originalHeight;a.maxWidth=a.originalWidth;a.imageRatioWide=a.originalWidth/a.originalHeight;a.imageRatioTall=a.originalHeight/a.originalWidth;if(a.originalHeight>a.frameHeight-a.marginReal||a.originalWidth>a.frameWidth-a.marginReal)u(a),a.targetImageHeight=a.minHeight,a.targetImageWidth=a.minWidth; a.positionerLeft=a.targetPositionerLeft=a.centerLeft;a.positionerTop=a.targetPositionerTop=a.centerTop;a.imageLeft=-a.targetImageWidth/2;a.imageTop=-a.targetImageHeight/2;a.imageHeight=a.targetImageHeight;a.imageWidth=a.targetImageWidth;a.$positioner.css({left:a.positionerLeft,top:a.positionerTop});a.$holder.css({left:a.imageLeft,top:a.imageTop,height:a.imageHeight,width:a.imageWidth}).append(a.$image).on("mousedown.zoomer",a,v);a.$image.animate({opacity:1},300);a.loading=!1}function u(a){a.originalHeight> a.originalWidth?(a.aspect="tall",a.minHeight=a.frameHeight-a.marginReal,a.minWidth=a.minHeight/a.imageRatioTall,a.minWidth>a.frameWidth-a.marginReal&&(a.minWidth=a.frameWidth-a.marginReal,a.minHeight=a.minWidth/a.imageRatioWide),a.step=(a.maxWidth-a.minWidth)/100):(a.aspect="wide",a.minWidth=a.frameWidth-a.marginReal,a.minHeight=a.minWidth/a.imageRatioWide,a.minHeight>a.frameHeight-a.marginReal&&(a.minHeight=a.frameHeight-a.marginReal,a.minWidth=a.minHeight/a.imageRatioTall),a.step=(a.maxHeight-a.minHeight)/ 100)}function y(a){a=a.data;a.keyDownTime=1;a.action="zoom_in"}function z(a){a=a.data;a.keyDownTime=1;a.action="zoom_out"}function t(a){a=a.data;a.keyDownTime=0;a.action=""}function v(a){a.preventDefault&&(a.preventDefault(),a.stopPropagation());var c=a.data;c.action="drag";c.mouseX=a.pageX;c.mouseY=a.pageY;d(window).on("mousemove.zoomer",c,w).on("mouseup.zoomer",c,C)}function w(a){a.preventDefault&&(a.preventDefault(),a.stopPropagation());var c=a.data;c.targetPositionerLeft-=c.mouseX-a.pageX;c.targetPositionerTop-= c.mouseY-a.pageY;c.mouseX=a.pageX;c.mouseY=a.pageY}function C(a){a.preventDefault();a.stopPropagation();a.data.action="";d(window).off(".zoomer")}function q(a){if(!(0<d(a.target).parent(".zoomer-controls").length)){a.preventManipulation&&a.preventManipulation();a.preventDefault();var c=a.data;a=a.originalEvent;c.touches=c.touches?c.touches:[];if(a.type.match(/(up|end)$/i))c.touches=[],c.currentContinuousZoom=c.newContinuousZoom,d(window).off(".zoomer");else{if(a.pointerId){var b=!1,l;for(l in c.touches)c.touches[l].identifier== a.pointerId&&(b=!0,c.touches[l].pageX=a.clientX,c.touches[l].pageY=a.clientY);b||c.touches.push({identifier:a.pointerId,pageX:a.clientX,pageY:a.clientY})}else c.touches=a.touches;a.type.match(/(down|start)$/i)?(d(window).on("touchmove.zoomer MSPointerMove.zoomer",c,q).on("touchend.zoomer MSPointerUp.zoomer",c,q),c.action="",c.currentContinuousZoom=1,1==c.touches.length?(v({data:c,pageX:c.touches[0].pageX,pageY:c.touches[0].pageY}),c.action="touch"):2<=c.touches.length&&(c.startX0=c.touches[0].pageX, c.startY0=c.touches[0].pageY,c.startX1=c.touches[1].pageX,c.startY1=c.touches[1].pageY,c.centerPointStartX=(c.startX0+c.startX1)/2,c.centerPointStartY=(c.startY0+c.startY1)/2,c.percentageOfImageAtPinchPointX=(c.centerPointStartX-c.positionerLeft)/c.imageWidth,c.percentageOfImageAtPinchPointY=(c.centerPointStartY-c.positionerTop)/c.imageHeight,c.startPinchDistance=Math.sqrt(Math.pow(c.startX1-c.startX0,2)+Math.pow(c.startY1-c.startY0,2)))):a.type.match(/move$/i)&&(1==c.touches.length?w({data:c,pageX:c.touches[0].pageX, pageY:c.touches[0].pageY}):2<=c.touches.length&&(c.action="pinch",c.endX0!=c.touches[0].pageX&&(c.endY0!=c.touches[0].pageY&&c.endX1!=c.touches[1].pageX&&c.endY1!=c.touches[1].pageY)&&(c.endX0=c.touches[0].pageX,c.endY0=c.touches[0].pageY,c.endX1=c.touches[1].pageX,c.endY1=c.touches[1].pageY,c.endPinchDistance=Math.sqrt(Math.pow(c.endX1-c.endX0,2)+Math.pow(c.endY1-c.endY0,2)),c.newContinuousZoom=c.endPinchDistance/c.startPinchDistance*c.currentContinuousZoom,c.targetImageWidth=c.imageWidth*c.newContinuousZoom, c.targetImageHeight=c.imageHeight*c.newContinuousZoom,c=_checkMinMax(c),c.centerPointEndX=(c.endX0+c.endX1)/2,c.centerPointEndY=(c.endY0+c.endY1)/2,c.translateFromZoomingX=(c.imageWidth-c.targetImageWidth)*c.percentageOfImageAtPinchPointX,c.translateFromZoomingY=(c.imageHeight-c.targetImageHeight)*c.percentageOfImageAtPinchPointY,c.translateFromTranslatingX=0,c.translateFromTranslatingY=0,c.translateTotalX=c.translateFromZoomingX+c.translateFromTranslatingX,c.translateTotalY=c.translateFromZoomingY+ c.translateFromTranslatingY,c.targetPositionerLeft=c.positionerLeft+c.translateTotalX,c.targetPositionerTop=c.positionerTop+c.translateTotalY)))}}}function s(){if(n){window.requestAnimationFrame(s);for(var a=0,c=m.length;a<c;a++){var b=m.eq(a).data("zoomer");if("null"!=typeof b){if(""!=b.action){b.keyDownTime+=b.increment;var d=b.imageWidth*b.keyDownTime-b.imageWidth;"zoom_in"==b.action?"tall"==b.aspect?(b.targetImageHeight+=d,b.targetImageWidth=b.targetImageHeight/b.imageRatioTall):(b.targetImageWidth+= d,b.targetImageHeight=b.targetImageWidth/b.imageRatioWide):"zoom_out"==b.action&&("tall"==b.aspect?(b.targetImageHeight-=d,b.targetImageWidth=b.targetImageHeight/b.imageRatioTall):(b.targetImageWidth-=d,b.targetImageHeight=b.targetImageWidth/b.imageRatioWide))}"tall"==b.aspect?b.targetImageHeight<b.minHeight?(b.targetImageHeight=b.minHeight,b.targetImageWidth=b.targetImageHeight/b.imageRatioTall):b.targetImageHeight>b.maxHeight&&(b.targetImageHeight=b.maxHeight,b.targetImageWidth=b.targetImageHeight/ b.imageRatioTall):b.targetImageWidth<b.minWidth?(b.targetImageWidth=b.minWidth,b.targetImageHeight=b.targetImageWidth/b.imageRatioWide):b.targetImageWidth>b.maxWidth&&(b.targetImageWidth=b.maxWidth,b.targetImageHeight=b.targetImageWidth/b.imageRatioWide);if("zoom_out"==b.action||"zoom_out"==b.lastAction){b.targetPositionerLeft+=b.positionerLeft<b.centerLeft?5:-5;b.targetPositionerTop+=b.positionerTop<b.centerTop?5:-5;var d=b.positionerLeft<b.centerLeft?"less":"more",e=b.positionerTop<b.centerTop? "less":"more";if("less"==d&&b.targetPositionerLeft>b.centerLeft||"more"==d&&b.targetPositionerLeft<b.centerLeft)b.targetPositionerLeft=b.centerLeft,b.targetPositionerLeft=b.centerleft;if("less"==e&&b.targetPositionerTop>b.centerTop||"more"==e&&b.targetPositionerTop<b.centerTop)b.targetPositionerTop=b.centerTop}b.boundsTop=b.frameHeight-0.5*b.targetImageHeight-g.margin;b.boundsBottom=0.5*b.targetImageHeight+g.margin;b.boundsLeft=b.frameWidth-0.5*b.targetImageWidth-g.margin;b.boundsRight=0.5*b.targetImageWidth+ g.margin;b.targetPositionerLeft<b.boundsLeft&&(b.targetPositionerLeft=b.boundsLeft);b.targetPositionerLeft>b.boundsRight&&(b.targetPositionerLeft=b.boundsRight);b.targetPositionerTop<b.boundsTop&&(b.targetPositionerTop=b.boundsTop);b.targetPositionerTop>b.boundsBottom&&(b.targetPositionerTop=b.boundsBottom);b.targetImageWidth<b.frameWidth&&(b.targetPositionerLeft=b.centerLeft);b.targetImageHeight<b.frameHeight&&(b.targetPositionerTop=b.centerTop);if(b.imageWidth!=b.targetImageWidth||b.positionLeft!= b.targetPositionerLeft)b.targetImageTop=-b.targetImageHeight/2,b.targetImageLeft=-b.targetImageWidth/2,d="pinch"==b.action||"touch"==b.action?0.5:b.enertia,b.imageWidth+=(b.targetImageWidth-b.imageWidth)*d,b.imageHeight+=(b.targetImageHeight-b.imageHeight)*d,b.imageLeft+=(b.targetImageLeft-b.imageLeft)*d,b.imageTop+=(b.targetImageTop-b.imageTop)*d,"drag"!=b.action&&"pinch"!=b.action?(b.positionerLeft+=(b.targetPositionerLeft-b.positionerLeft)*d,b.positionerTop+=(b.targetPositionerTop-b.positionerTop)* d):(b.positionerLeft=b.targetPositionerLeft,b.positionerTop=b.targetPositionerTop),b.$positioner.css({left:b.positionerLeft,top:b.positionerTop}),b.$holder.css({left:b.imageLeft,top:b.imageTop,height:b.imageHeight,width:b.imageWidth});b.lastAction=b.action}}}}var g={controls:{position:"bottom",zoomIn:null,zoomOut:null,next:null,previous:null},customClass:"",enertia:0.2,increment:0.02,margin:100,retina:!1},x={action:"",lastAction:"",keyDownTime:0,centerLeft:0,centerTop:0,frameHeight:0,frameWidth:0, minHeight:null,minWidth:null,maxHeight:0,maxWidth:0,marginReal:0,originalHeight:0,originalWidth:0,imageRatioWide:0,imageRatioTall:0,targetImageWidth:0,targetImageHeight:0,targetImageLeft:0,targetImageTop:0,imageWidth:0,imageHeight:0,imageLeft:0,imageTop:0,targetPositionerLeft:0,targetPositionerTop:0,positionerLeft:0,positionerTop:0,boundsTop:0,boundsBottom:0,boundsLeft:0,boundsRight:0},n=!1,m,p={defaults:function(a){g=d.extend(g,a||{});return d(this)},destroy:function(){d(this).each(function(){var a= d(this).data("zoomer");a.$target.removeClass("zoomer-element").data("zoomer",null);a.$holder.off(".zoomer");a.$zoomer.remove();a.controls.$zoomIn.off(".zoomer");a.controls.$zoomOut.off(".zoomer")});m=d(".zoomer-element");1>m.length&&(n=!1);return d(this)},load:function(a){return d(this).each(function(){var c=d(this).data("zoomer");c.images="string"==typeof a?[a]:a;c.index=0;k(c)})},resize:function(){return d(this).each(function(){var a=d(this).data("zoomer");"undefined"!=typeof a&&(a.frameWidth=a.$target.outerWidth(), a.frameHeight=a.$target.outerHeight(),a.centerLeft=a.frameWidth/2,a.centerTop=a.frameHeight/2,u(a))})},unload:function(){return d(this).each(function(){var a=d(this).data("zoomer");"undefined"!=typeof a.$image&&a.$image.remove()})}};d.fn.zoomer=function(a){return p[a]?p[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!==typeof a&&a?this:f.apply(this,arguments)}})(jQuery);

// Request Animation Frame Polyfill 
// Paul Irish <https://gist.github.com/paulirish/1579671>
(function(){for(var d=0,f=["webkit","moz"],e=0;e<f.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[f[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[f[e]+"CancelAnimationFrame"]||window[f[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,f){var k=(new Date).getTime(),h=Math.max(0,16-(k-d)),r=window.setTimeout(function(){e(k+h)},h);d=k+h;return r});window.cancelAnimationFrame||(window.cancelAnimationFrame= function(d){clearTimeout(d)})})();