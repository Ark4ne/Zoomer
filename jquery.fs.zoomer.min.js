/*
 * Zoomer [Formstone Library]
 * @author Ben Plum
 * @version 0.0.1
 *
 * Copyright Â© 2012 Ben Plum <mr@benplum.com>
 * Released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 */
 
if(jQuery)(function(d){var h;function p(a){a=d.extend({},j,q,a);a.$target=d(this);a.$zoomer=d('<div class="zoomer" class="'+j.customClass+'"><div class="zoomer-positioner"><div class="zoomer-holder"></div></div></div>');a.$target.addClass("zoomer-element").append(a.$zoomer);a.$positioner=a.$zoomer.find(".zoomer-positioner");a.$holder=a.$zoomer.find(".zoomer-holder");a.controls.$zoomIn.on("mousedown.zoomer",a,r).on("mouseup.zoomer",a,k);a.controls.$zoomOut.on("mousedown.zoomer",a,s).on("mouseup.zoomer",a,k); a.$target.data("zoomer",a);f.resize.apply(a.$target);a.source&&f.load.apply(a.$target,[a.source]);g||l();return a.$target}function m(a,c){a.$image=d('<img style="opacity: 0;" />');a.$image.one("load.zoomer",a,t).attr("src",c).addClass("zoomer-image");a.$image[0].complete&&a.$image.trigger("load")}function t(a){a=a.data;a.originalHeight=a.$image[0].height;a.originalWidth=a.$image[0].width;a.retina&&(a.originalHeight/=2,a.originalWidth/=2);a.targetImageHeight=a.originalHeight;a.targetImageWidth=a.originalWidth; a.maxHeight=a.originalHeight;a.maxWidth=a.originalWidth;a.imageRatioWide=a.originalWidth/a.originalHeight;a.imageRatioTall=a.originalHeight/a.originalWidth;if(a.originalHeight>a.frameHeight-a.padding||a.originalWidth>a.frameWidth-a.padding)a.originalHeight>a.originalWidth?(a.aspect="tall",a.targetImageHeight=a.frameHeight-a.padding,a.targetImageWidth=a.targetImageHeight/a.imageRatioTall,a.targetImageWidth>a.frameWidth-a.padding&&(a.imageRatio=imageHolder.width/imageHolder.height,a.targetImageWidth= a.frameWidth-a.padding,a.targetImageHeight=a.targetImageWidth/a.imageRatioWide),a.minWidth=a.minHeight/a.imageRatioTall,a.step=(a.maxWidth-a.minWidth)/100):(a.aspect="wide",a.targetImageWidth=a.frameWidth-a.padding,a.targetImageHeight=a.targetImageWidth/a.imageRatioWide,a.targetImageHeight>a.frameHeight-a.padding&&(a.targetImageHeight=a.frameHeight-a.padding,a.targetImageWidth=a.targetImageHeight/a.imageRatioTall),a.minHeight=a.minWidth/a.imageRatioWide,a.step=(a.maxHeight-a.minHeight)/100);a.originalWidth< a.minWidth&&(a.minWidth=a.originalWidth);a.originalHeight<a.minHeight&&(a.minHeight=a.originalHeight);n(a);a.positionerLeft=a.targetPositionerLeft=a.centerLeft;a.positionerTop=a.targetPositionerTop=a.centerTop;a.imageLeft=-a.targetImageWidth/2;a.imageTop=-a.targetImageHeight/2;a.imageHeight=a.targetImageHeight;a.imageWidth=a.targetImageWidth;a.$positioner.css({left:a.positionerLeft,top:a.positionerTop});a.$holder.css({left:a.imageLeft,top:a.imageTop,height:a.imageHeight,width:a.imageWidth}).append(a.$image).on("mousedown.zoomer", a,u);a.$image.animate({opacity:1},a.animationSpeed)}function r(a){a=a.data;a.keyDownTime=1;a.action="zoom_in"}function s(a){a=a.data;a.keyDownTime=1;a.action="zoom_out"}function k(a){a=a.data;a.keyDownTime=0;a.action=""}function u(a){a.preventDefault();a.stopPropagation();var c=a.data;c.action="drag";console.log(c.boundsLeft,c.boundsRight,c.boundsTop,c.boundsBottom);n(c);console.log(c.boundsLeft,c.boundsRight,c.boundsTop,c.boundsBottom,c.centerLeft);console.log("---");c.mouseX=a.pageX;c.mouseY=a.pageY; d(window).on("mouseup.zoomer",c,v).on("mousemove.zoomer",c,w)}function v(a){a.preventDefault();a.stopPropagation();a.data.action="";d(window).off(".zoomer")}function w(a){a.preventDefault();a.stopPropagation();var c=a.data;c.targetPositionerLeft-=c.mouseX-a.pageX;c.targetPositionerTop-=c.mouseY-a.pageY;c.mouseX=a.pageX;c.mouseY=a.pageY}function n(a){a.boundsTop=a.centerTop-a.imageHeight/2;a.boundsBottom=a.centerTop+a.imageHeight/2;a.boundsLeft=a.centerLeft-a.imageWidth/2;a.boundsRight=a.centerLeft+ a.imageWidth/2}function l(){g=setTimeout(l,28);h=d(".zoomer-element");for(var a=0,c=h.length;a<c;a++){var b=h.eq(a).data("zoomer");if("null"!=typeof b){b.lastAction=b.action;if(""!=b.action){b.keyDownTime+=0.025;var e=b.imageWidth*b.keyDownTime-b.imageWidth;if("zoom_in"==b.action)"tall"==b.aspect?(b.targetImageHeight+=e,b.targetImageWidth=b.targetImageHeight/b.imageRatioTall):(b.targetImageWidth+=e,b.targetImageHeight=b.targetImageWidth/b.imageRatioWide);else if("zoom_out"==b.action){"tall"==b.aspect? (b.targetImageHeight-=e,b.targetImageWidth=b.targetImageHeight/b.imageRatioTall):(b.targetImageWidth-=e,b.targetImageHeight=b.targetImageWidth/b.imageRatioWide);b.targetPositionerLeft+=b.positionerLeft<b.centerLeft?e:-e;b.targetPositionerTop+=b.positionerTop<b.centerTop?e:-e;var e=b.positionerLeft<b.centerLeft?"less":"more",f=b.positionerTop<b.centerTop?"less":"more";"less"==e&&b.targetPositionerLeft>b.centerLeft?b.targetPositionerLeft=b.centerLeft:"more"==e&&b.targetPositionerLeft<b.centerLeft&& (b.targetPositionerLeft=b.centerleft);"less"==f&&b.targetPositionerTop>b.centerTop?b.targetPositionerTop=b.centerTop:"more"==f&&b.targetPositionerTop<b.centerTop&&(b.targetPositionerTop=b.centerTop)}"tall"==b.aspect?b.targetImageHeight<b.minHeight?(b.targetImageHeight=b.minHeight,b.targetImageWidth=b.targetImageHeight/b.imageRatioTall):b.targetImageHeight>b.maxHeight&&(b.targetImageHeight=b.maxHeight,b.targetImageWidth=b.targetImageHeight/b.imageRatioTall):b.targetImageWidth<b.minWidth?(b.targetImageWidth= b.minWidth,b.targetImageHeight=b.targetImageWidth/b.imageRatioWide):b.targetImageWidth>b.maxWidth&&(b.targetImageWidth=b.maxWidth,b.targetImageHeight=b.targetImageWidth/b.imageRatioWide)}if(b.imageWidth!=b.targetImageWidth||b.positionLeft!=b.targetPositionerLeft)b.targetImageWidth<b.frameWidth&&(b.targetPositionerLeft=b.centerLeft),b.targetImageHeight<b.frameHeight&&(b.targetPositionerTop=b.centerTop),b.targetPositionerLeft<b.boundsLeft&&(b.targetPositionerLeft=b.boundsLeft),b.targetPositionerLeft> b.boundsRight&&(b.targetPositionerLeft=b.boundsRight),b.targetPositionerTop<b.boundsTop&&(b.targetPositionerTop=b.boundsTop),b.targetPositionerTop>b.boundsBottom&&(b.targetPositionerTop=b.boundsBottom),b.targetImageTop=-b.targetImageHeight/2,b.targetImageLeft=-b.targetImageWidth/2,b.imageWidth+=(b.targetImageWidth-b.imageWidth)*b.animationInterval,b.imageHeight+=(b.targetImageHeight-b.imageHeight)*b.animationInterval,b.imageLeft+=(b.targetImageLeft-b.imageLeft)*b.animationInterval,b.imageTop+=(b.targetImageTop- b.imageTop)*b.animationInterval,"drag"!=b.action?(b.positionerLeft+=(b.targetPositionerLeft-b.positionerLeft)*b.animationInterval,b.positionerTop+=(b.targetPositionerTop-b.positionerTop)*b.animationInterval):(b.positionerLeft=b.targetPositionerLeft,b.positionerTop=b.targetPositionerTop),b.$positioner.css({left:b.positionerLeft,top:b.positionerTop}),b.$holder.css({left:b.imageLeft,top:b.imageTop,height:b.imageHeight,width:b.imageWidth})}}}var j={animationSpeed:300,controls:{$zoomIn:d(),$zoomOut:d()}, customClass:"",retina:!1},q={animationInterval:0.2,action:"",lastAction:"",keyDownTime:0,centerLeft:0,centerTop:0,frameHeight:0,frameWidth:0,minHeight:100,minWidth:100,maxHeight:0,maxWidth:0,padding:200,originalHeight:0,originalWidth:0,imageRatioWide:0,imageRatioTall:0,targetImageWidth:0,targetImageHeight:0,targetImageLeft:0,targetImageTop:0,imageWidth:0,imageHeight:0,imageLeft:0,imageTop:0,targetPositionerLeft:0,targetPositionerTop:0,positionerLeft:0,positionerTop:0,boundsTop:0,boundsBottom:0,boundsLeft:0, boundsRight:0},g=null;h=void 0;var f={defaults:function(a){j=d.extend(j,a||{});return d(this)},destroy:function(){data.$target.removeClass("zoomer-element").data("zoomer",null);data.$zoomer.remove();data.controls.$zoomIn.off(".zoomer");data.controls.$zoomOut.off(".zoomer");g&&(clearTimout(g),g=null);return d(this).off(".zoomer")},load:function(a){var c=d(this).data("zoomer");"undefined"!=typeof c.$image?c.$image.animate({opacity:0},c.animationSpeed,function(){f.unload.apply(c.$target);m.apply(c.$target, [c,a])}):m.apply(c.$target,[c,a])},resize:function(){var a=d(this).data("zoomer");"undefined"!=typeof a.$target&&(a.frameWidth=a.$target.outerWidth(),a.frameHeight=a.$target.outerHeight(),a.centerLeft=a.frameWidth/2,a.centerTop=a.frameHeight/2)},unload:function(){var a=d(this).data("zoomer");"undefined"!=typeof a.$target&&a.$image.remove()}};d.fn.zoomer=function(a){return f[a]?f[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"===typeof a||!a?p.apply(this,arguments):this}})(jQuery);