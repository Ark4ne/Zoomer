/*
 * Zoomer [Formstone Library]
 * @author Ben Plum
 * @version 0.0.5.1
 *
 * Copyright Â© 2012 Ben Plum <mr@benplum.com>
 * Released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 */
 
if(jQuery)(function(e){function q(a){a=e.extend({},k,r,a);for(var c=e(this),b=0,d=c.length;b<d;b++)s.apply(c.eq(b),[e.extend({},a)]);g=e(".zoomer-element");h||l();return c}function s(a){a.$target=e(this);a.$zoomer=e('<div class="zoomer '+a.customClass+'"><div class="zoomer-positioner"><div class="zoomer-holder"></div></div></div>');a.$target.addClass("zoomer-element").append(a.$zoomer);a.$positioner=a.$zoomer.find(".zoomer-positioner");a.$holder=a.$zoomer.find(".zoomer-holder");a.controls.$zoomIn.on("mousedown.zoomer", a,t).on("mouseup.zoomer",a,m);a.controls.$zoomOut.on("mousedown.zoomer",a,u).on("mouseup.zoomer",a,m);a.marginReal=2*a.margin;a.$target.data("zoomer",a);j.resize.apply(a.$target);a.source&&j.load.apply(a.$target,[a.source])}function n(a,c){a.$image=e('<img style="opacity: 0;" />');a.$image.one("load.zoomer",a,v).attr("src",c).addClass("zoomer-image");a.$image[0].complete&&a.$image.trigger("load")}function v(a){a=a.data;a.originalHeight=a.$image[0].height;a.originalWidth=a.$image[0].width;a.retina&& (a.originalHeight/=2,a.originalWidth/=2);a.targetImageHeight=a.originalHeight;a.targetImageWidth=a.originalWidth;a.maxHeight=a.originalHeight;a.maxWidth=a.originalWidth;a.imageRatioWide=a.originalWidth/a.originalHeight;a.imageRatioTall=a.originalHeight/a.originalWidth;if(a.originalHeight>a.frameHeight-a.marginReal||a.originalWidth>a.frameWidth-a.marginReal)p(a),a.targetImageHeight=a.minHeight,a.targetImageWidth=a.minWidth;a.positionerLeft=a.targetPositionerLeft=a.centerLeft;a.positionerTop=a.targetPositionerTop= a.centerTop;a.imageLeft=-a.targetImageWidth/2;a.imageTop=-a.targetImageHeight/2;a.imageHeight=a.targetImageHeight;a.imageWidth=a.targetImageWidth;a.$positioner.css({left:a.positionerLeft,top:a.positionerTop});a.$holder.css({left:a.imageLeft,top:a.imageTop,height:a.imageHeight,width:a.imageWidth}).append(a.$image).on("mousedown.zoomer",a,w);a.$image.animate({opacity:1},a.animationSpeed)}function t(a){a=a.data;a.keyDownTime=1;a.action="zoom_in"}function u(a){a=a.data;a.keyDownTime=1;a.action="zoom_out"} function m(a){a=a.data;a.keyDownTime=0;a.action=""}function w(a){a.preventDefault();a.stopPropagation();var c=a.data;c.action="drag";c.mouseX=a.pageX;c.mouseY=a.pageY;e(window).on("mouseup.zoomer",c,x).on("mousemove.zoomer",c,y)}function x(a){a.preventDefault();a.stopPropagation();a.data.action="";e(window).off(".zoomer")}function y(a){a.preventDefault();a.stopPropagation();var c=a.data;c.targetPositionerLeft-=c.mouseX-a.pageX;c.targetPositionerTop-=c.mouseY-a.pageY;c.mouseX=a.pageX;c.mouseY=a.pageY} function p(a){a.originalHeight>a.originalWidth?(a.aspect="tall",a.minHeight=a.frameHeight-a.marginReal,a.minWidth=a.minHeight/a.imageRatioTall,a.minWidth>a.frameWidth-a.marginReal&&(a.minWidth=a.frameWidth-a.marginReal,a.minHeight=a.minWidth/a.imageRatioWide),a.step=(a.maxWidth-a.minWidth)/100):(a.aspect="wide",a.minWidth=a.frameWidth-a.marginReal,a.minHeight=a.minWidth/a.imageRatioWide,a.minHeight>a.frameHeight-a.marginReal&&(a.minHeight=a.frameHeight-a.marginReal,a.minWidth=a.minHeight/a.imageRatioTall), a.step=(a.maxHeight-a.minHeight)/100)}function l(){h=setTimeout(l,28);for(var a=0,c=g.length;a<c;a++){var b=g.eq(a).data("zoomer");if("null"!=typeof b){if(""!=b.action){b.keyDownTime+=b.keyDownIncrement;var d=b.imageWidth*b.keyDownTime-b.imageWidth;"zoom_in"==b.action?"tall"==b.aspect?(b.targetImageHeight+=d,b.targetImageWidth=b.targetImageHeight/b.imageRatioTall):(b.targetImageWidth+=d,b.targetImageHeight=b.targetImageWidth/b.imageRatioWide):"zoom_out"==b.action&&("tall"==b.aspect?(b.targetImageHeight-= d,b.targetImageWidth=b.targetImageHeight/b.imageRatioTall):(b.targetImageWidth-=d,b.targetImageHeight=b.targetImageWidth/b.imageRatioWide));"tall"==b.aspect?b.targetImageHeight<b.minHeight?(b.targetImageHeight=b.minHeight,b.targetImageWidth=b.targetImageHeight/b.imageRatioTall):b.targetImageHeight>b.maxHeight&&(b.targetImageHeight=b.maxHeight,b.targetImageWidth=b.targetImageHeight/b.imageRatioTall):b.targetImageWidth<b.minWidth?(b.targetImageWidth=b.minWidth,b.targetImageHeight=b.targetImageWidth/ b.imageRatioWide):b.targetImageWidth>b.maxWidth&&(b.targetImageWidth=b.maxWidth,b.targetImageHeight=b.targetImageWidth/b.imageRatioWide)}if("zoom_out"==b.action||"zoom_out"==b.lastAction){b.targetPositionerLeft+=b.positionerLeft<b.centerLeft?5:-5;b.targetPositionerTop+=b.positionerTop<b.centerTop?5:-5;var d=b.positionerLeft<b.centerLeft?"less":"more",e=b.positionerTop<b.centerTop?"less":"more";if("less"==d&&b.targetPositionerLeft>b.centerLeft||"more"==d&&b.targetPositionerLeft<b.centerLeft)b.targetPositionerLeft= b.centerLeft,b.targetPositionerLeft=b.centerleft;if("less"==e&&b.targetPositionerTop>b.centerTop||"more"==e&&b.targetPositionerTop<b.centerTop)b.targetPositionerTop=b.centerTop}b.boundsTop=b.centerTop-b.targetImageHeight/2;b.boundsBottom=b.centerTop+b.targetImageHeight/2;b.boundsLeft=b.centerLeft-b.targetImageWidth/2;b.boundsRight=b.centerLeft+b.targetImageWidth/2;if(b.imageWidth!=b.targetImageWidth||b.positionLeft!=b.targetPositionerLeft)b.targetImageWidth<b.frameWidth&&(b.targetPositionerLeft=b.centerLeft), b.targetImageHeight<b.frameHeight&&(b.targetPositionerTop=b.centerTop),b.targetPositionerLeft<b.boundsLeft&&(b.targetPositionerLeft=b.boundsLeft),b.targetPositionerLeft>b.boundsRight&&(b.targetPositionerLeft=b.boundsRight),b.targetPositionerTop<b.boundsTop&&(b.targetPositionerTop=b.boundsTop),b.targetPositionerTop>b.boundsBottom&&(b.targetPositionerTop=b.boundsBottom),b.targetImageTop=-b.targetImageHeight/2,b.targetImageLeft=-b.targetImageWidth/2,b.imageWidth+=(b.targetImageWidth-b.imageWidth)*b.animationInterval, b.imageHeight+=(b.targetImageHeight-b.imageHeight)*b.animationInterval,b.imageLeft+=(b.targetImageLeft-b.imageLeft)*b.animationInterval,b.imageTop+=(b.targetImageTop-b.imageTop)*b.animationInterval,"drag"!=b.action?(b.positionerLeft+=(b.targetPositionerLeft-b.positionerLeft)*b.animationInterval,b.positionerTop+=(b.targetPositionerTop-b.positionerTop)*b.animationInterval):(b.positionerLeft=b.targetPositionerLeft,b.positionerTop=b.targetPositionerTop),b.$positioner.css({left:b.positionerLeft,top:b.positionerTop}), b.$holder.css({left:b.imageLeft,top:b.imageTop,height:b.imageHeight,width:b.imageWidth});b.lastAction=b.action}}}var k={animationSpeed:300,controls:{$zoomIn:e(),$zoomOut:e()},customClass:"",margin:100,retina:!1,source:null},r={animationInterval:0.2,action:"",lastAction:"",keyDownTime:0,keyDownIncrement:0.05,centerLeft:0,centerTop:0,frameHeight:0,frameWidth:0,minHeight:null,minWidth:null,maxHeight:0,maxWidth:0,marginReal:0,originalHeight:0,originalWidth:0,imageRatioWide:0,imageRatioTall:0,targetImageWidth:0, targetImageHeight:0,targetImageLeft:0,targetImageTop:0,imageWidth:0,imageHeight:0,imageLeft:0,imageTop:0,targetPositionerLeft:0,targetPositionerTop:0,positionerLeft:0,positionerTop:0,boundsTop:0,boundsBottom:0,boundsLeft:0,boundsRight:0},h=null,g,j={defaults:function(a){k=e.extend(k,a||{});return e(this)},destroy:function(){for(var a=e(this),c=0,b=a.length;c<b;c++){var d=a.eq(c).data("zoomer");d.$target.removeClass("zoomer-element").data("zoomer",null);d.$holder.off(".zoomer");d.$zoomer.remove(); d.controls.$zoomIn.off(".zoomer");d.controls.$zoomOut.off(".zoomer")}g=e(".zoomer-element");1>g.length&&h&&(clearTimeout(h),h=null);return a},load:function(a){for(var c=e(this),b=0,d=c.length;b<d;b++){var f=c.eq(b).data("zoomer");"undefined"!=typeof f.$image?f.$image.animate({opacity:0},f.animationSpeed,function(){j.unload.apply(f.$target);n.apply(f.$target,[f,a])}):n.apply(f.$target,[f,a])}return c},resize:function(){for(var a=e(this),c=0,b=a.length;c<b;c++){var d=a.eq(c).data("zoomer");"undefined"!= typeof d.$target&&(d.frameWidth=d.$target.outerWidth(),d.frameHeight=d.$target.outerHeight(),d.centerLeft=d.frameWidth/2,d.centerTop=d.frameHeight/2,p(d))}return a},unload:function(){for(var a=e(this),c=0,b=a.length;c<b;c++){var d=a.eq(c).data("zoomer");"undefined"!=typeof d.$target&&d.$image.remove()}return a}};e.fn.zoomer=function(a){return j[a]?j[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"===typeof a||!a?q.apply(this,arguments):this}})(jQuery);